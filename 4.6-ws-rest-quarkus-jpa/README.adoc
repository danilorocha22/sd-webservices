:source-highlighter: highlightjs
:numbered:

ifdef::env-github[]
:outfilesuffix: .adoc
:caution-caption: :fire:
:important-caption: :exclamation:
:note-caption: :paperclip:
:tip-caption: :bulb:
:warning-caption: :warning:
endif::[]

= Exemplo de Aplica√ß√£o REST utilizando Java com JAX-RS, CDI, JPA e o framework Quarkus

Se voc√™ chegou at√© aqui e n√£o sabe o que √© https://quarkus.io[Quarkus], veja o link:../4.5-ws-rest-quarkus-framework[projeto anterior]. Este projeto √© baseado na estrutura do anterior.

Esta vers√£o inclui suporte √† inje√ß√£o de depend√™ncias com CDI e acesso √† banco de dados com a Java Persistence API (JPA) utilizando o framework Hibernate.

== Requisitos

Al√©m do JDK 8 e Maven 3.5.3 ou superior, este projeto usa o MySQL/MariaDB como banco de dados.
No entanto, voc√™ pode utilizar qualquer banco que desejar, desde que fa√ßa as configura√ß√µes adequadas para o banco escolhido. Para isto, √© preciso incluir o driver JDBC para o seu banco a partir das depend√™ncias do Quarkus no pom.xml. Para o MySQL/MariaDB foi inclu√≠do:

[source,xml]
----

    <dependency>
        <groupId>io.quarkus</groupId>
        <artifactId>quarkus-jdbc-mariadb</artifactId>
    </dependency>
----

As configura√ß√µes da conex√£o devem ser definidas em arquivo link:src/main/resources/application.properties[application.properties].

== Detalhes do Projeto

Foi inclu√≠do o arquivo link:src/main/webapp/WEB-INF/beans.xml[beans.xml] para configurar o CDI. Tal arquivo n√£o √© necess√°rio desde o Java EE 7 e de fato o Quarkus parece estar ignorando o mesmo (ou ele n√£o foi colocado na pasta correta).

As configura√ß√µes do DataSource para conex√£o com o banco foram feitas no arquivo link:src/main/resources/application.properties[application.properties] e n√£o no persistence.xml. Apesar de ser poss√≠vel utilizar o persistence.xml como usual, voc√™ n√£o pode incluir os dois arquivos no projeto. De qualuqer forma, a configura√ß√£o pelo application.properties √© muito mais simples.

Veja que como o servidor ser√° embutido na nossa aplica√ß√£o, precisamos indicar qual o banco de dados ser√° usado, inclu√≠ndo uma depend√™ncia para isso no pom.xml. Neste caso o banco de dados usado pode ser o MariaDB ou MySQL. Assim foi inclu√≠da a depend√™ncia `quarkus-jdbc-mariadb`. Observe que, apesar de tal depend√™ncia ser para o MariaDB, ela funciona com o MySQL (pois o MariaDB √© apenas um fork do MySQL).
Mas para isto, foi preciso definir no application.properties que desejamos usar o dialeto SQL do MySQL.
Neste caso, como estou utilizando MySQL 8, foi definida a classe `org.hibernate.dialect.MySQL8Dialect` no application.properties. Se estiver usando uma vers√£o diferente do MySQL, pode consultar o nome da classe que implementa o dialeto da sua vers√£o https://docs.jboss.org/hibernate/stable/orm/javadocs/org/hibernate/dialect/package-summary.html[aqui].

Certifique-se de criar o banco com o nome indicado no application.properties e indicar o nome de usu√°rio e senha do servidor de banco de dados, al√©m de outras poss√≠veis configura√ß√µes para o seu banco.

Por fim, que as depend√™ncias que normalmente inclu√≠mos em um projeto JavaEE com Hibernate seriam javax.javaee-web-api, org.hibernate.javax.persistence e possivelmente outras depend√™ncias relacionadas a API JAX-RS e processamento de JSON. Ao usar um framework como o Quarkus que embute um servidor na pr√≥pria aplica√ß√£o, tais depend√™ncias n√£o devem ser inclu√≠das do modo tradicional (usando os pacotes fornecidos pelo desenvolvedor destas bibliotecas), mas sim as vers√µes de tais bibliotecas disponibilizadas por ferramentas como o Quarkus.

Assim, veja que no link:pom.xml[pom.xml] que tais bibliotecas usadas foram fornecidas pelo pr√≥prio Quarkus.

== Executar o Projeto

== Ambiente de Desenvolvimento 

=== Iniciando o servidor

Voc√™ pode iniciar o servidor com sua aplica√ß√£o de diferentes maneiras:

- Usando o script mvnw inclu√≠do durante a cria√ß√£o do projeto: `./mvnw compile quarkus:dev`.
- Ou simplesmente clicando no bot√£o Play em IDEs como o NetBeans, pois foi inclu√≠do o plugin maven exec para executar o comando acima mais facilmente.

=== Atualizando o projeto sem reiniciar o servidor

Bem, atualizar o projeto no servidor em execu√ß√£o e ver as altera√ß√µes que voc√™ fez na sua aplica√ß√£o √© realmente complicado com o Quarkus: voc√™ precisa apenas salvar o projeto e boom: normalmente em menos de 1 segundo a aplica√ß√£o estar√° rodando com as novas altera√ß√µes üò±üöÄüòÅ.

N√£o √© √† toa que o slogan do Quarkus √© "Supersonic Subatomic Java".

=== Acessando a aplica√ß√£o

Se voc√™ estiver habituado a usar servidores como o GlassFish no NetBeans, sabe que ao clicar no bot√£o Play, o projeto √© compilado e executado, abrindo o navegador automaticamente.
Usando o Quarkus isso n√£o ocorrer√°.
Voc√™ deve abrir o navegador voc√™ mesmo. Neste caso, a aplica√ß√£o estar√° dispon√≠vel
em http://localhost:8080. Observe que n√£o h√° um caminho adicional com o nome da aplica√ß√£o no final da URL, pois a aplica√ß√£o executa na raiz do servidor.

== Ambiente de Produ√ß√£o

Para enviar a aplica√ß√£o para um ambiente de produ√ß√£o voc√™ deve executar `./mvnw clean package` em um terminal na raiz do projeto para criar o que chamamos de uber jar. Este √© um tipo de jar que cont√©m tudo que a aplica√ß√£o precisa para executar:

- a pr√≥pria aplica√ß√£o;
- o servidor que executar√° a aplica√ß√£o;
- todas as depend√™ncias necess√°rias (arquivos jar das bibliotecas usadas).

Com o comando acima o pacote `target/rest-app-quarkus-server-jpa-runner.jar` √© criado e a partir dele podemos iniciar o servidor com a aplica√ß√£o. Assim, este √© o *√∫nico* pacote que precisa ser enviado para o ambiente de produ√ß√£o. 

=== Configura√ß√µes no Ambiente de Produ√ß√£o.

Observe que o arquivo link:src/main/resources/application.properties[application.properties]
possui vari√°veis iniciando com `%dev.` e outras com `%prod.`, para indicar,
respectivamente, configura√ß√µes para o ambiente de desenvolvimento e ambiente de produ√ß√£o.
Normalmente teremos configura√ß√µes distintas em tais ambientes, como:

- diferente IP do servidor de banco de dados e posssivelmente diferente usu√°rio e senha;
- diferente porta para rodar o servidor de aplica√ß√£o (normalmente 8080 em desenvolvimento e 80 em produ√ß√£o).

Assim, para indicar que deseja rodar a aplica√ß√£o no ambiente de produ√ß√£o, existem diversas maneiras,
como criar uma vari√°vel de ambiente com o comando `export QUARKUS_PROFILE=prod`. Em linux, tal comando pode ser inclu√≠do em arquivos como o `~/.bashrc`, `~/.bash_profile` ou `~/.profile`. Assim, ao logar no servidor com o usu√°rio que usou para editar algum destes arquivos, a vari√°vel j√° ser√° criada.

IMPORTANT: Certifique-se que o arquivo que voc√™ escolheu acima realmente existe. Se n√£o existir, tente um dos outros arquivos.

Ap√≥s editar um dos arquivos acima, √© preciso execut√°-lo para a vari√°vel ser de fato criada.
Se incluiu a linha acima no arquivo `~/.profile`, dever√° executar `source ~/.profile` para isto.

Como no arquivo application.properties foi definido que no ambiente de produ√ß√£o
ser√° usada a porta 80, no Linux √© preciso usar root para executar a aplica√ß√£o:

[source,bash]
----
sudo java -jar rest-app-quarkus-server-jpa-runner.jar
----

Ao rodar a aplica√ß√£o agora, ela vai entender que est√° no ambiente de produ√ß√£o e usar as configura√ß√µes de tal ambiente a partir do arquivo application.properties.

=== Container Docker

Para gerar containers com tudo necess√°rio para executar a aplica√ß√£o, e assim facilitar a implanta√ß√£o (deploy) dela, veja esta link:docker-container.adoc[p√°gina]. 

== Refer√™ncias

- https://quarkus.io
- https://quarkus.io/guides/getting-started-guide
- https://quarkus.io/guides/building-native-image-guide
- https://quarkus.io/guides/rest-json-guide
- https://lordofthejars.github.io/quarkus-cheat-sheet/
- https://quarkus.io/guides/application-configuration-guide